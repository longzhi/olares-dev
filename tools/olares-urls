#!/bin/bash
KUBECTL="/tmp/kubectl"
NAMESPACE="opencode-dev-onetest02"
DOMAIN="onetest02.olares.com"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo -e "${BLUE}  OpenCode 部署的应用${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""

APPS=$($KUBECTL get deployments -n "$NAMESPACE" -l deployed-by=opencode -o name 2>/dev/null | cut -d/ -f2)

if [ -z "$APPS" ]; then
    echo "  ⚠️  没有找到已部署的应用"
    exit 0
fi

for APP in $APPS; do
    # 获取第三级域名
    THIRD_LEVEL=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.metadata.annotations.applications\.app\.bytetrade\.io/default-thirdlevel-domains}' 2>/dev/null | python3 -c "import sys,json; data=json.load(sys.stdin); print(data[0]['thirdLevelDomain'])" 2>/dev/null)
    
    # 获取端口
    PORT=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.spec.template.spec.containers[0].ports[0].containerPort}' 2>/dev/null)
    
    # 获取状态
    READY=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.status.readyReplicas}' 2>/dev/null)
    TOTAL=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.spec.replicas}' 2>/dev/null)
    
    echo -e "${GREEN}▶${NC} $APP"
    
    if [ "$READY" = "$TOTAL" ] && [ "$READY" != "" ]; then
        echo -e "  状态: ${GREEN}✅ Running ($READY/$TOTAL)${NC}"
    else
        echo -e "  状态: ${YELLOW}⚠️  $READY/$TOTAL${NC}"
    fi
    
    if [ -n "$THIRD_LEVEL" ]; then
        echo "  端口: $PORT"
        echo -e "  访问地址: ${GREEN}https://${THIRD_LEVEL}.${DOMAIN}/${APP}/${NC}"
        echo "  代码目录: /root/workspace/${APP}"
    else
        echo -e "  ${YELLOW}⚠️  未配置访问地址（使用旧版脚本部署）${NC}"
    fi
    
    echo ""
done

echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""
echo "💡 提示："
echo "  • 浏览器访问可能需要 1-2 分钟等待路由配置生效"
echo "  • 使用 /tmp/opencode-deploy-v2.sh 部署新应用会自动配置外部访问"
echo ""
