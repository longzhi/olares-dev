#!/bin/bash

# Auto-detect kubectl path
if command -v kubectl &> /dev/null; then
    KUBECTL=$(command -v kubectl)
elif [ -x "/usr/local/bin/kubectl" ]; then
    KUBECTL="/usr/local/bin/kubectl"
elif [ -x "/tmp/kubectl" ]; then
    KUBECTL="/tmp/kubectl"
else
    echo "Error: kubectl not found" >&2
    exit 1
fi

NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo "default")
OWNER="${OLARES_USER:-$(echo $NAMESPACE | sed 's/.*-//')}"

# AppID = md5(app_name)[:8] + entrance_index (0 for first entrance)
OPENCODE_APP=$(echo $NAMESPACE | cut -d'-' -f1)
OPENCODE_APPID="$(echo -n "$OPENCODE_APP" | md5sum | cut -c1-8)0"

DOMAIN="${OWNER}.olares.com"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo -e "${BLUE}  OpenCode Deployed Apps${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""

APPS=$($KUBECTL get deployments -n "$NAMESPACE" -l deployed-by=opencode -o name 2>/dev/null | cut -d/ -f2)

if [ -z "$APPS" ]; then
    echo "  ⚠️  No deployed apps found"
    exit 0
fi

for APP in $APPS; do
    # Get port
    PORT=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.spec.template.spec.containers[0].ports[0].containerPort}' 2>/dev/null)
    
    # Get status
    READY=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.status.readyReplicas}' 2>/dev/null)
    TOTAL=$($KUBECTL get deployment "$APP" -n "$NAMESPACE" -o jsonpath='{.spec.replicas}' 2>/dev/null)
    
    echo -e "${GREEN}▶${NC} $APP"
    
    if [ "$READY" = "$TOTAL" ] && [ "$READY" != "" ]; then
        echo -e "  Status: ${GREEN}✅ Running ($READY/$TOTAL)${NC}"
    else
        echo -e "  Status: ${YELLOW}⚠️  $READY/$TOTAL${NC}"
    fi
    
    echo "  Port: $PORT"
    echo -e "  Access URL: ${GREEN}https://${OPENCODE_APPID}.${DOMAIN}/${APP}/${NC}"
    echo "  Code directory: /root/workspace/${APP}"
    
    echo ""
done

echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""
echo "💡 Tips:"
echo "  • All apps accessed via OpenCode Nginx reverse proxy"
echo "  • OpenCode AppID: ${OPENCODE_APPID}"
echo "  • Base URL: https://${OPENCODE_APPID}.${DOMAIN}/"
echo ""
