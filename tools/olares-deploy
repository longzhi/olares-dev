#!/bin/bash

set -e

KUBECTL="/tmp/kubectl"
NAMESPACE="opencode-dev-onetest02"
OWNER="onetest02"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function log_info() {
    echo -e "${GREEN}[✓]${NC} $1"
}

function log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

function log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

function log_step() {
    echo -e "${BLUE}[▶]${NC} $1"
}

if [ $# -lt 3 ]; then
    log_error "参数不足"
    echo "用法: $0 <app-name> <image> <port> [command]"
    exit 1
fi

APP_NAME="$1"
IMAGE="$2"
PORT="$3"
COMMAND="${4:-}"

if ! [[ "$APP_NAME" =~ ^[a-z0-9-]+$ ]]; then
    log_error "应用名称无效：$APP_NAME（只能包含小写字母、数字和连字符）"
    exit 1
fi

log_step "开始部署应用"
echo "  应用名称: $APP_NAME"
echo "  镜像: $IMAGE"
echo "  端口: $PORT"
echo "  Namespace: $NAMESPACE"
[ -n "$COMMAND" ] && echo "  启动命令: $COMMAND"

MANIFEST_FILE="/tmp/${APP_NAME}-deployment.yaml"

log_step "生成 Kubernetes manifest..."

if [ -n "$COMMAND" ]; then
    CONTAINER_COMMAND='
        command: ["/bin/sh", "-c"]
        args:
          - |
            '"$COMMAND"
else
    CONTAINER_COMMAND=''
fi

RANDOM_SUFFIX=$(echo $RANDOM | md5sum | head -c 8)
THIRD_LEVEL_DOMAIN="${RANDOM_SUFFIX}-${PORT}"

ENTRANCES_JSON="[{\"name\":\"${APP_NAME}\",\"host\":\"${APP_NAME}-svc\",\"port\":${PORT},\"title\":\"${APP_NAME}\",\"authLevel\":\"private\",\"openMethod\":\"default\"}]"
DOMAINS_JSON="[{\"appName\":\"${APP_NAME}\",\"entranceName\":\"${APP_NAME}\",\"thirdLevelDomain\":\"${THIRD_LEVEL_DOMAIN}\"}]"

cat > "$MANIFEST_FILE" <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
    deployed-by: opencode
    applications.app.bytetrade.io/name: ${APP_NAME}
    applications.app.bytetrade.io/owner: ${OWNER}
  annotations:
    meta.helm.sh/release-name: ${APP_NAME}
    meta.helm.sh/release-namespace: ${NAMESPACE}
    applications.app.bytetrade.io/entrances: '${ENTRANCES_JSON}'
    applications.app.bytetrade.io/default-thirdlevel-domains: '${DOMAINS_JSON}'
    applications.app.bytetrade.io/icon: https://app.cdn.olares.com/appstore/default/defaulticon.webp
    applications.app.bytetrade.io/title: ${APP_NAME}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${APP_NAME}
  template:
    metadata:
      labels:
        app: ${APP_NAME}
      annotations:
        meta.helm.sh/release-name: ${APP_NAME}
        meta.helm.sh/release-namespace: ${NAMESPACE}
    spec:
      containers:
      - name: ${APP_NAME}
        image: ${IMAGE}${CONTAINER_COMMAND}
        ports:
        - containerPort: ${PORT}
          name: http
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: ${APP_NAME}-svc
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
spec:
  type: ClusterIP
  selector:
    app: ${APP_NAME}
  ports:
  - port: ${PORT}
    targetPort: ${PORT}
    protocol: TCP
    name: http
EOF

log_info "Manifest 已生成: $MANIFEST_FILE"

log_step "部署到 Kubernetes..."
if $KUBECTL apply -f "$MANIFEST_FILE" 2>&1; then
    log_info "部署成功！"
else
    log_error "部署失败"
    exit 1
fi

log_step "等待 Pod 启动..."
sleep 2

for i in {1..30}; do
    POD_STATUS=$($KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME" -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
    
    if [ "$POD_STATUS" = "Running" ]; then
        log_info "Pod 已启动"
        break
    elif [ "$POD_STATUS" = "Failed" ] || [ "$POD_STATUS" = "Error" ]; then
        log_error "Pod 启动失败"
        $KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
        exit 1
    fi
    
    echo -n "."
    sleep 2
done
echo ""

if [ "$POD_STATUS" != "Running" ]; then
    log_warning "Pod 未在预期时间内启动，当前状态: $POD_STATUS"
fi

log_step "部署信息:"
echo ""
$KUBECTL get deployment "$APP_NAME" -n "$NAMESPACE"
echo ""
$KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
echo ""
$KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE"
echo ""

CLUSTER_IP=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}' 2>/dev/null)

log_info "应用已部署完成！"
echo ""
echo "  ✅ 内部访问地址（集群内）:"
echo "    http://${APP_NAME}-svc.${NAMESPACE}.svc.cluster.local:${PORT}"
echo "    http://${CLUSTER_IP}:${PORT}"
echo ""
log_warning "  ⚠️  外部访问配置已添加 entrance annotations"
log_warning "  需要 Olares 的 Ingress Controller 处理才能从浏览器访问"
log_warning "  第三级域名: ${THIRD_LEVEL_DOMAIN}"
echo ""
echo "  查看日志:"
echo "    $KUBECTL logs -n $NAMESPACE -l app=$APP_NAME -f"
echo ""
echo "  删除应用:"
echo "    $KUBECTL delete deployment $APP_NAME -n $NAMESPACE"
echo "    $KUBECTL delete service ${APP_NAME}-svc -n $NAMESPACE"
echo ""
