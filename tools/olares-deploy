#!/bin/bash

set -e

# Auto-detect kubectl path
if command -v kubectl &> /dev/null; then
    KUBECTL=$(command -v kubectl)
elif [ -x "/usr/local/bin/kubectl" ]; then
    KUBECTL="/usr/local/bin/kubectl"
elif [ -x "/tmp/kubectl" ]; then
    KUBECTL="/tmp/kubectl"
else
    echo "Error: kubectl not found" >&2
    exit 1
fi

NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo "default")
OWNER=$(echo "$NAMESPACE" | sed 's/.*-//')

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function log_info() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

function log_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

function log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

function log_step() {
    echo -e "${BLUE}[‚ñ∂]${NC} $1"
}

if [ $# -lt 3 ]; then
    log_error "Insufficient arguments"
    echo "Usage: $0 <app-name> <image> <port> [command]"
    exit 1
fi

APP_NAME="$1"
IMAGE="$2"
PORT="$3"
COMMAND="${4:-}"

if ! [[ "$APP_NAME" =~ ^[a-z0-9-]+$ ]]; then
    log_error "Invalid app name: $APP_NAME (only lowercase letters, numbers, and hyphens allowed)"
    exit 1
fi

log_step "Starting deployment"
echo "  App name: $APP_NAME"
echo "  Image: $IMAGE"
echo "  Port: $PORT"
echo "  Namespace: $NAMESPACE"
[ -n "$COMMAND" ] && echo "  Startup command: $COMMAND"

MANIFEST_FILE="/tmp/${APP_NAME}-deployment.yaml"

# Dynamically resolve workspace hostPath
# In Olares environment, /root/workspace may be a symlink or mount point
WORKSPACE_PATH="/root/workspace"
if [ -L "$WORKSPACE_PATH" ]; then
    # If symlink, get real path
    HOST_WORKSPACE_PATH=$(readlink -f "$WORKSPACE_PATH")
elif [ -d "$WORKSPACE_PATH" ]; then
    # Try to get real path from mount info
    MOUNT_INFO=$(df "$WORKSPACE_PATH" 2>/dev/null | tail -1 | awk '{print $NF}')
    if [ "$MOUNT_INFO" != "/" ] && [ -n "$MOUNT_INFO" ]; then
        HOST_WORKSPACE_PATH="$MOUNT_INFO"
    else
        # Fallback to default path
        HOST_WORKSPACE_PATH="$WORKSPACE_PATH"
    fi
else
    HOST_WORKSPACE_PATH="$WORKSPACE_PATH"
fi

log_step "Generating Kubernetes manifest..."
echo "  Workspace hostPath: $HOST_WORKSPACE_PATH"

if [ -n "$COMMAND" ]; then
    CONTAINER_COMMAND='
        command: ["/bin/sh", "-c"]
        args:
          - |
            '"$COMMAND"
else
    CONTAINER_COMMAND=''
fi

# Calculate OpenCode AppID for access URL
# AppID = md5(app_name)[:8] + entrance_index
# OpenCode app name is extracted from namespace (format: {app-name}-{username})
OPENCODE_APP=$(echo $NAMESPACE | cut -d'-' -f1)
OPENCODE_HASH=$(echo -n "$OPENCODE_APP" | md5sum | cut -c1-8)
OPENCODE_APPID="${OPENCODE_HASH}0"  # First entrance (index 0)

ENTRANCES_JSON="[{\"name\":\"${APP_NAME}\",\"host\":\"${APP_NAME}-svc\",\"port\":${PORT},\"title\":\"${APP_NAME}\",\"authLevel\":\"private\",\"openMethod\":\"default\"}]"

cat > "$MANIFEST_FILE" <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
    deployed-by: opencode
    applications.app.bytetrade.io/name: ${APP_NAME}
    applications.app.bytetrade.io/owner: ${OWNER}
  annotations:
    meta.helm.sh/release-name: ${APP_NAME}
    meta.helm.sh/release-namespace: ${NAMESPACE}
    applications.app.bytetrade.io/entrances: '${ENTRANCES_JSON}'
    applications.app.bytetrade.io/icon: https://app.cdn.olares.com/appstore/default/defaulticon.webp
    applications.app.bytetrade.io/title: ${APP_NAME}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${APP_NAME}
  template:
    metadata:
      labels:
        app: ${APP_NAME}
      annotations:
        meta.helm.sh/release-name: ${APP_NAME}
        meta.helm.sh/release-namespace: ${NAMESPACE}
    spec:
      containers:
      - name: ${APP_NAME}
        image: ${IMAGE}${CONTAINER_COMMAND}
        workingDir: /app
        ports:
        - containerPort: ${PORT}
          name: http
        env:
        # Database configuration (auto-injected from Olares environment)
        - name: DB_HOST
          value: "${DB_HOST:-}"
        - name: DB_PORT
          value: "${DB_PORT:-5432}"
        - name: DB_USER
          value: "${DB_USER:-}"
        - name: DB_PASSWORD
          value: "${DB_PASSWORD:-}"
        - name: DB_DATABASE
          value: "${DB_DATABASE:-}"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        volumeMounts:
        - name: workspace
          mountPath: /app
          subPath: ${APP_NAME}
      volumes:
      - name: workspace
        hostPath:
          path: ${HOST_WORKSPACE_PATH}
          type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: ${APP_NAME}-svc
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
spec:
  type: ClusterIP
  selector:
    app: ${APP_NAME}
  ports:
  - port: ${PORT}
    targetPort: ${PORT}
    protocol: TCP
    name: http
EOF

log_info "Manifest generated: $MANIFEST_FILE"

log_step "Deploying to Kubernetes..."
if $KUBECTL apply -f "$MANIFEST_FILE" 2>&1; then
    log_info "Deployment successful!"
else
    log_error "Deployment failed"
    exit 1
fi

log_step "Waiting for Pod to start..."
sleep 2

for i in {1..30}; do
    POD_STATUS=$($KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME" -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
    
    if [ "$POD_STATUS" = "Running" ]; then
        log_info "Pod started"
        break
    elif [ "$POD_STATUS" = "Failed" ] || [ "$POD_STATUS" = "Error" ]; then
        log_error "Pod failed to start"
        $KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
        exit 1
    fi
    
    echo -n "."
    sleep 2
done
echo ""

if [ "$POD_STATUS" != "Running" ]; then
    log_warning "Pod did not start within expected time, current status: $POD_STATUS"
fi

log_step "Deployment info:"
echo ""
$KUBECTL get deployment "$APP_NAME" -n "$NAMESPACE"
echo ""
$KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
echo ""
$KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE"
echo ""

log_info "App deployment complete!"

echo ""
echo "  üåê Access URL: https://${OPENCODE_APPID}.${OWNER}.olares.com/${APP_NAME}/"
echo ""
echo "  üìÅ Code directory: /root/workspace/${APP_NAME}"
echo ""
echo "  View logs: olares-manage logs ${APP_NAME}"
echo "  Delete app: olares-manage delete ${APP_NAME}"
echo ""
