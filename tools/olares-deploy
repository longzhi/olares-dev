#!/bin/bash

set -e

# Auto-detect kubectl path
if command -v kubectl &> /dev/null; then
    KUBECTL=$(command -v kubectl)
elif [ -x "/usr/local/bin/kubectl" ]; then
    KUBECTL="/usr/local/bin/kubectl"
elif [ -x "/tmp/kubectl" ]; then
    KUBECTL="/tmp/kubectl"
else
    echo "Error: kubectl not found" >&2
    exit 1
fi

NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo "default")
OWNER=$(echo "$NAMESPACE" | sed 's/.*-//')

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function log_info() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

function log_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

function log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

function log_step() {
    echo -e "${BLUE}[‚ñ∂]${NC} $1"
}

if [ $# -lt 3 ]; then
    log_error "Insufficient arguments"
    echo "Usage: $0 <app-name> <image> <port> [command]"
    exit 1
fi

APP_NAME="$1"
IMAGE="$2"
PORT="$3"
COMMAND="${4:-}"

if ! [[ "$APP_NAME" =~ ^[a-z0-9-]+$ ]]; then
    log_error "Invalid app name: $APP_NAME (only lowercase letters, numbers, and hyphens allowed)"
    exit 1
fi

WORKSPACE_PATH="/root/workspace"
APP_PATH="${WORKSPACE_PATH}/${APP_NAME}"

log_step "Starting deployment"
echo "  App name: $APP_NAME"
echo "  Image: $IMAGE"
echo "  Port: $PORT"
echo "  Namespace: $NAMESPACE"
[ -n "$COMMAND" ] && echo "  Startup command: $COMMAND"

# Check if app directory exists
if [ ! -d "$APP_PATH" ]; then
    log_error "App directory not found: $APP_PATH"
    echo "  Please create your app in /root/workspace/${APP_NAME}/ first"
    exit 1
fi

# Check directory size (ConfigMap limit is 1MB)
log_step "Checking app directory size..."
APP_SIZE=$(du -sb "$APP_PATH" 2>/dev/null | cut -f1)
APP_SIZE_KB=$((APP_SIZE / 1024))
APP_SIZE_MB=$((APP_SIZE / 1024 / 1024))

echo "  App size: ${APP_SIZE_KB} KB"

if [ "$APP_SIZE" -gt 1048576 ]; then
    log_error "App directory too large: ${APP_SIZE_MB} MB (ConfigMap limit: 1MB)"
    echo ""
    echo "  Solutions:"
    echo "  1. Remove unnecessary files (node_modules, __pycache__, .git, etc.)"
    echo "  2. Use .dockerignore patterns to exclude files"
    echo "  3. For large apps, consider building a Docker image instead"
    exit 1
fi

# Create ConfigMap from app directory
log_step "Creating ConfigMap from app code..."
CONFIGMAP_NAME="${APP_NAME}-code"

# Delete existing ConfigMap if exists
$KUBECTL delete configmap "$CONFIGMAP_NAME" -n "$NAMESPACE" 2>/dev/null || true

# Create ConfigMap with all files (excluding common unnecessary files)
cd "$APP_PATH"
if ! $KUBECTL create configmap "$CONFIGMAP_NAME" \
    --from-file=. \
    -n "$NAMESPACE" 2>&1; then
    log_error "Failed to create ConfigMap"
    echo "  This may be due to binary files or special characters in filenames"
    echo "  Try removing binary files or use a Docker image instead"
    exit 1
fi

log_info "ConfigMap created: $CONFIGMAP_NAME"

MANIFEST_FILE="/tmp/${APP_NAME}-deployment.yaml"

if [ -n "$COMMAND" ]; then
    # Wrap command to first copy code from ConfigMap to working directory
    INIT_AND_COMMAND="cp -r /code/* /app/ 2>/dev/null || true; cd /app; $COMMAND"
    CONTAINER_COMMAND='
        command: ["/bin/sh", "-c"]
        args:
          - |
            '"$INIT_AND_COMMAND"
else
    # Default: just copy code
    CONTAINER_COMMAND='
        command: ["/bin/sh", "-c"]
        args:
          - |
            cp -r /code/* /app/ 2>/dev/null || true
            cd /app
            echo "No startup command specified. Container will stay running."
            tail -f /dev/null'
fi

# Calculate OpenCode AppID for access URL
OPENCODE_APP=$(echo $NAMESPACE | cut -d'-' -f1)
OPENCODE_HASH=$(echo -n "$OPENCODE_APP" | md5sum | cut -c1-8)
OPENCODE_APPID="${OPENCODE_HASH}0"

ENTRANCES_JSON="[{\"name\":\"${APP_NAME}\",\"host\":\"${APP_NAME}-svc\",\"port\":${PORT},\"title\":\"${APP_NAME}\",\"authLevel\":\"private\",\"openMethod\":\"default\"}]"

log_step "Generating Kubernetes manifest..."

cat > "$MANIFEST_FILE" <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
    deployed-by: opencode
    applications.app.bytetrade.io/name: ${APP_NAME}
    applications.app.bytetrade.io/owner: ${OWNER}
  annotations:
    meta.helm.sh/release-name: ${APP_NAME}
    meta.helm.sh/release-namespace: ${NAMESPACE}
    applications.app.bytetrade.io/entrances: '${ENTRANCES_JSON}'
    applications.app.bytetrade.io/icon: https://app.cdn.olares.com/appstore/default/defaulticon.webp
    applications.app.bytetrade.io/title: ${APP_NAME}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${APP_NAME}
  template:
    metadata:
      labels:
        app: ${APP_NAME}
      annotations:
        meta.helm.sh/release-name: ${APP_NAME}
        meta.helm.sh/release-namespace: ${NAMESPACE}
    spec:
      containers:
      - name: ${APP_NAME}
        image: ${IMAGE}${CONTAINER_COMMAND}
        workingDir: /app
        ports:
        - containerPort: ${PORT}
          name: http
        env:
        # Database configuration (auto-injected from Olares environment)
        - name: DB_HOST
          value: "${DB_HOST:-}"
        - name: DB_PORT
          value: "${DB_PORT:-5432}"
        - name: DB_USER
          value: "${DB_USER:-}"
        - name: DB_PASSWORD
          value: "${DB_PASSWORD:-}"
        - name: DB_DATABASE
          value: "${DB_DATABASE:-}"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        volumeMounts:
        - name: code
          mountPath: /code
          readOnly: true
        - name: app-workdir
          mountPath: /app
      volumes:
      - name: code
        configMap:
          name: ${CONFIGMAP_NAME}
      - name: app-workdir
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: ${APP_NAME}-svc
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
spec:
  type: ClusterIP
  selector:
    app: ${APP_NAME}
  ports:
  - port: ${PORT}
    targetPort: ${PORT}
    protocol: TCP
    name: http
EOF

log_info "Manifest generated: $MANIFEST_FILE"

log_step "Deploying to Kubernetes..."
if $KUBECTL apply -f "$MANIFEST_FILE" 2>&1; then
    log_info "Deployment successful!"
else
    log_error "Deployment failed"
    exit 1
fi

log_step "Waiting for Pod to start..."
sleep 2

for i in {1..30}; do
    POD_STATUS=$($KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME" -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
    
    if [ "$POD_STATUS" = "Running" ]; then
        log_info "Pod started"
        break
    elif [ "$POD_STATUS" = "Failed" ] || [ "$POD_STATUS" = "Error" ]; then
        log_error "Pod failed to start"
        $KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
        exit 1
    fi
    
    echo -n "."
    sleep 2
done
echo ""

if [ "$POD_STATUS" != "Running" ]; then
    log_warning "Pod did not start within expected time, current status: $POD_STATUS"
fi

log_step "Deployment info:"
echo ""
$KUBECTL get deployment "$APP_NAME" -n "$NAMESPACE"
echo ""
$KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
echo ""
$KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE"
echo ""

# Auto-configure Nginx reverse proxy
log_step "Configuring Nginx reverse proxy..."
NGINX_CONFIG_SCRIPT="/root/.local/bin/olares-nginx-config"
if [ -f "$NGINX_CONFIG_SCRIPT" ]; then
    if python3 "$NGINX_CONFIG_SCRIPT" 2>&1; then
        log_info "Nginx configured successfully"
    else
        log_warning "Nginx configuration failed, you may need to run manually:"
        echo "  python3 $NGINX_CONFIG_SCRIPT"
    fi
else
    log_warning "Nginx config script not found at $NGINX_CONFIG_SCRIPT"
    echo "  Please configure Nginx manually"
fi

log_info "App deployment complete!"

echo ""
echo "  üåê Access URL: https://${OPENCODE_APPID}.${OWNER}.olares.com/${APP_NAME}/"
echo ""
echo "  üìÅ Code directory: /root/workspace/${APP_NAME}"
echo "  üì¶ ConfigMap: ${CONFIGMAP_NAME}"
echo ""
echo "  Update code: Re-run this deploy command after editing files"
echo "  View logs: /root/.local/bin/olares-manage logs ${APP_NAME}"
echo "  Delete app: /root/.local/bin/olares-manage delete ${APP_NAME}"
echo ""
