#!/bin/bash

set -e

# Auto-detect kubectl path
if command -v kubectl &> /dev/null; then
    KUBECTL=$(command -v kubectl)
elif [ -x "/usr/local/bin/kubectl" ]; then
    KUBECTL="/usr/local/bin/kubectl"
elif [ -x "/tmp/kubectl" ]; then
    KUBECTL="/tmp/kubectl"
else
    echo "Error: kubectl not found" >&2
    exit 1
fi

NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo "default")

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function log_info() {
    echo -e "${GREEN}[✓]${NC} $1"
}

function log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

function log_step() {
    echo -e "${BLUE}[▶]${NC} $1"
}

function list_apps() {
    log_step "Deployed applications"
    echo ""
    
    $KUBECTL get deployments -n "$NAMESPACE" -l deployed-by=opencode -o custom-columns=\
NAME:.metadata.name,\
IMAGE:.spec.template.spec.containers[0].image,\
PORT:.spec.template.spec.containers[0].ports[0].containerPort,\
READY:.status.readyReplicas,\
AGE:.metadata.creationTimestamp 2>/dev/null || {
        log_error "Failed to get app list"
        return 1
    }
    
    echo ""
}

function show_app_info() {
    local APP_NAME="$1"
    
    if [ -z "$APP_NAME" ]; then
        log_error "Please specify app name"
        return 1
    fi
    
    log_step "App details: $APP_NAME"
    echo ""
    
    $KUBECTL get deployment "$APP_NAME" -n "$NAMESPACE" || {
        log_error "App not found: $APP_NAME"
        return 1
    }
    
    echo ""
    $KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
    
    echo ""
    $KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" 2>/dev/null || {
        log_error "Service not found"
    }
    
    echo ""
    CLUSTER_IP=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}' 2>/dev/null)
    PORT=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}' 2>/dev/null)
    
    if [ -n "$CLUSTER_IP" ]; then
        log_info "Access URLs:"
        echo "  http://${APP_NAME}-svc.${NAMESPACE}.svc.cluster.local:${PORT}"
        echo "  http://${CLUSTER_IP}:${PORT}"
    fi
    
    echo ""
}

function show_logs() {
    local APP_NAME="$1"
    local FOLLOW="${2:-}"
    
    if [ -z "$APP_NAME" ]; then
        log_error "Please specify app name"
        return 1
    fi
    
    log_step "Viewing logs: $APP_NAME"
    
    if [ "$FOLLOW" = "-f" ] || [ "$FOLLOW" = "--follow" ]; then
        $KUBECTL logs -n "$NAMESPACE" -l app="$APP_NAME" -f
    else
        $KUBECTL logs -n "$NAMESPACE" -l app="$APP_NAME" --tail=50
    fi
}

function delete_app() {
    local APP_NAME="$1"
    
    if [ -z "$APP_NAME" ]; then
        log_error "Please specify app name"
        return 1
    fi
    
    log_step "Deleting app: $APP_NAME"
    
    $KUBECTL delete deployment "$APP_NAME" -n "$NAMESPACE" 2>/dev/null && \
        log_info "Deployment deleted" || \
        log_error "Deployment deletion failed or not found"
    
    $KUBECTL delete service "${APP_NAME}-svc" -n "$NAMESPACE" 2>/dev/null && \
        log_info "Service deleted" || \
        log_error "Service deletion failed or not found"
    
    # Also delete ConfigMap (created by olares-deploy)
    $KUBECTL delete configmap "${APP_NAME}-code" -n "$NAMESPACE" 2>/dev/null && \
        log_info "ConfigMap deleted" || \
        echo "  (No ConfigMap found, may be using older deployment method)"
    
    echo ""
}

function test_app() {
    local APP_NAME="$1"
    
    if [ -z "$APP_NAME" ]; then
        log_error "Please specify app name"
        return 1
    fi
    
    log_step "Testing app connection: $APP_NAME"
    
    CLUSTER_IP=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}' 2>/dev/null)
    PORT=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}' 2>/dev/null)
    
    if [ -z "$CLUSTER_IP" ]; then
        log_error "Unable to get Service info"
        return 1
    fi
    
    echo "  URL: http://${CLUSTER_IP}:${PORT}"
    echo ""
    
    if curl -s --max-time 5 "http://${CLUSTER_IP}:${PORT}" > /dev/null 2>&1; then
        log_info "App responding normally"
        curl -s "http://${CLUSTER_IP}:${PORT}" | head -20
    else
        log_error "App not responding"
        return 1
    fi
    
    echo ""
}

function show_usage() {
    cat <<EOF
OpenCode App Management Tool

Usage: $0 <command> [arguments]

Commands:
  list                      List all deployed apps
  info <app-name>           Show app details
  logs <app-name> [-f]      View app logs (-f for follow)
  delete <app-name>         Delete app
  test <app-name>           Test app connection

Examples:
  $0 list
  $0 info flask-hello
  $0 logs flask-hello -f
  $0 delete flask-hello
  $0 test my-app

EOF
}

COMMAND="${1:-list}"

case "$COMMAND" in
    list)
        list_apps
        ;;
    info)
        show_app_info "$2"
        ;;
    logs)
        show_logs "$2" "$3"
        ;;
    delete)
        delete_app "$2"
        ;;
    test)
        test_app "$2"
        ;;
    -h|--help|help)
        show_usage
        ;;
    *)
        log_error "Unknown command: $COMMAND"
        echo ""
        show_usage
        exit 1
        ;;
esac
