#!/bin/bash

set -e

KUBECTL="/tmp/kubectl"
NAMESPACE="opencode-dev-onetest02"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function log_info() {
    echo -e "${GREEN}[✓]${NC} $1"
}

function log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

function log_step() {
    echo -e "${BLUE}[▶]${NC} $1"
}

function list_apps() {
    log_step "已部署的应用列表"
    echo ""
    
    $KUBECTL get deployments -n "$NAMESPACE" -l deployed-by=opencode -o custom-columns=\
NAME:.metadata.name,\
IMAGE:.spec.template.spec.containers[0].image,\
PORT:.spec.template.spec.containers[0].ports[0].containerPort,\
READY:.status.readyReplicas,\
AGE:.metadata.creationTimestamp 2>/dev/null || {
        log_error "获取应用列表失败"
        return 1
    }
    
    echo ""
}

function show_app_info() {
    local APP_NAME="$1"
    
    if [ -z "$APP_NAME" ]; then
        log_error "请指定应用名称"
        return 1
    fi
    
    log_step "应用详情: $APP_NAME"
    echo ""
    
    $KUBECTL get deployment "$APP_NAME" -n "$NAMESPACE" || {
        log_error "应用不存在: $APP_NAME"
        return 1
    }
    
    echo ""
    $KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
    
    echo ""
    $KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" 2>/dev/null || {
        log_error "Service 不存在"
    }
    
    echo ""
    CLUSTER_IP=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}' 2>/dev/null)
    PORT=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}' 2>/dev/null)
    
    if [ -n "$CLUSTER_IP" ]; then
        log_info "访问地址:"
        echo "  http://${APP_NAME}-svc.${NAMESPACE}.svc.cluster.local:${PORT}"
        echo "  http://${CLUSTER_IP}:${PORT}"
    fi
    
    echo ""
}

function show_logs() {
    local APP_NAME="$1"
    local FOLLOW="${2:-}"
    
    if [ -z "$APP_NAME" ]; then
        log_error "请指定应用名称"
        return 1
    fi
    
    log_step "查看日志: $APP_NAME"
    
    if [ "$FOLLOW" = "-f" ] || [ "$FOLLOW" = "--follow" ]; then
        $KUBECTL logs -n "$NAMESPACE" -l app="$APP_NAME" -f
    else
        $KUBECTL logs -n "$NAMESPACE" -l app="$APP_NAME" --tail=50
    fi
}

function delete_app() {
    local APP_NAME="$1"
    
    if [ -z "$APP_NAME" ]; then
        log_error "请指定应用名称"
        return 1
    fi
    
    log_step "删除应用: $APP_NAME"
    
    $KUBECTL delete deployment "$APP_NAME" -n "$NAMESPACE" 2>/dev/null && \
        log_info "Deployment 已删除" || \
        log_error "Deployment 删除失败或不存在"
    
    $KUBECTL delete service "${APP_NAME}-svc" -n "$NAMESPACE" 2>/dev/null && \
        log_info "Service 已删除" || \
        log_error "Service 删除失败或不存在"
    
    echo ""
}

function test_app() {
    local APP_NAME="$1"
    
    if [ -z "$APP_NAME" ]; then
        log_error "请指定应用名称"
        return 1
    fi
    
    log_step "测试应用连接: $APP_NAME"
    
    CLUSTER_IP=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}' 2>/dev/null)
    PORT=$($KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}' 2>/dev/null)
    
    if [ -z "$CLUSTER_IP" ]; then
        log_error "无法获取 Service 信息"
        return 1
    fi
    
    echo "  URL: http://${CLUSTER_IP}:${PORT}"
    echo ""
    
    if curl -s --max-time 5 "http://${CLUSTER_IP}:${PORT}" > /dev/null 2>&1; then
        log_info "应用响应正常"
        curl -s "http://${CLUSTER_IP}:${PORT}" | head -20
    else
        log_error "应用无响应"
        return 1
    fi
    
    echo ""
}

function show_usage() {
    cat <<EOF
OpenCode 应用管理工具

用法: $0 <命令> [参数]

命令:
  list                      列出所有已部署的应用
  info <app-name>           显示应用详细信息
  logs <app-name> [-f]      查看应用日志 (-f 持续跟踪)
  delete <app-name>         删除应用
  test <app-name>           测试应用连接

示例:
  $0 list
  $0 info flask-hello
  $0 logs flask-hello -f
  $0 delete flask-hello
    $0 test my-app

EOF
}

COMMAND="${1:-list}"

case "$COMMAND" in
    list)
        list_apps
        ;;
    info)
        show_app_info "$2"
        ;;
    logs)
        show_logs "$2" "$3"
        ;;
    delete)
        delete_app "$2"
        ;;
    test)
        test_app "$2"
        ;;
    -h|--help|help)
        show_usage
        ;;
    *)
        log_error "未知命令: $COMMAND"
        echo ""
        show_usage
        exit 1
        ;;
esac
